#!/bin/bash

# add - Agregar nota a un cheat-sheet y hacer commit automático

# Load environment variables
if [ -f "$HOME/bin/.env" ]; then 
    set -a
    source "$HOME/bin/.env"
    set +a
fi

DIR="${CHEAT_SHEETS_DIR:-$HOME/cheat-sheet}"
FILE="$DIR/$1.md"
NOTE=$2
DATE=$(date '+%Y-%m-%d %H:%M')
ID=$(date '+%Y%m%d%H%M%S')

if [[ -z "$1" ]]; then
  echo "Uso: cheat add <archivo> \"nota\""
  exit 1
fi

if [[ -z "$NOTE" ]]; then
  # Si no hay nota, abrir editor
  echo "Abriendo editor para crear nota en $1.md..."
  TEMP_NOTE=$(mktemp)
  EDITOR=${EDITOR:-nano}
  "$EDITOR" "$TEMP_NOTE"
  NOTE=$(cat "$TEMP_NOTE")
  rm "$TEMP_NOTE"
  
  if [[ -z "$NOTE" ]]; then
    echo "Nota vacía. Operación cancelada."
    exit 0
  fi
fi

# Crear directorio si no existe
mkdir -p "$DIR"

# Crear archivo si no existe
if [[ ! -f "$FILE" ]]; then
  echo "# $1" > "$FILE"
  echo "" >> "$FILE"
fi

# Detectar si la nota tiene aliases (líneas que empiecen con @)
ALIASES=""
if [[ "$NOTE" == *"@"* ]]; then
  # Extraer aliases de la nota
  ALIASES=$(echo "$NOTE" | grep -o '@[a-zA-Z0-9_-]*' | tr '\n' ' ' | sed 's/^@//' | sed 's/ @/ /g')
fi

{
  echo "<!-- cheat:start -->"
  echo "id: $ID"
  if [[ -n "$ALIASES" ]]; then
    echo "aliases: $ALIASES"
  fi
  echo "note: $NOTE"
  echo "date: $DATE"
  echo "<!-- cheat:end -->"
  echo ""
} >> "$FILE"

exit 1