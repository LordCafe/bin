#!/bin/bash

# check-aliases - Verificar aliases duplicados en el knowledge base

# Load environment variables
if [ -f "$HOME/bin/.env" ]; then 
    set -a
    source "$HOME/bin/.env"
    set +a
fi

DIR="${CHEAT_SHEETS_DIR:-$HOME/cheat-sheet}"

echo "Verificando aliases √∫nicos en tu knowledge base..."
echo "="$(printf '%.0s' {1..50})

# Crear archivo temporal con todos los aliases
TEMP_ALIASES=$(mktemp)

for FILE in "$DIR"/*.md; do
  [[ ! -f "$FILE" ]] && continue
  
  FILENAME=$(basename "$FILE" .md)
  
  # Extraer aliases de cada entrada
  awk -v filename="$FILENAME" '
    /<!-- cheat:start -->/ {block=1; id=""; note_line=""; in_note=0}
    block && /^id:/ {id=$2}
    block && /^note:/ {in_note=1; sub("note: ?", ""); note_line=$0; next}
    block && in_note && !/^date:/ {
      note_line = note_line "\n" $0
      next
    }
    block && /^date:/ {in_note=0}
    /<!-- cheat:end -->/ {
      if (block && id && note_line) {
        # Buscar todos los aliases en el contenido completo de la nota
        temp_note = note_line
        while (match(temp_note, /@[a-zA-Z0-9_-][a-zA-Z0-9_-]*/)) {
          alias = substr(temp_note, RSTART+1, RLENGTH-1)
          print alias "|" filename "|" id
          temp_note = substr(temp_note, RSTART+RLENGTH)
        }
      }
      block=0; note_line=""
    }
  ' "$FILE"
done > "$TEMP_ALIASES"

# Verificar duplicados
echo "Aliases encontrados:"
echo

DUPLICATES_FOUND=false

# Obtener aliases √∫nicos para verificar duplicados
sort "$TEMP_ALIASES" | uniq | while IFS='|' read -r alias filename id; do
  [[ -z "$alias" ]] && continue
  
  # Contar cu√°ntas veces aparece este alias
  COUNT=$(grep "^$alias|" "$TEMP_ALIASES" | wc -l)
  
  if [[ $COUNT -gt 1 ]]; then
    if [[ "$DUPLICATES_FOUND" == "false" ]]; then
      echo "‚ö†Ô∏è  ALIASES DUPLICADOS ENCONTRADOS:"
      echo
      DUPLICATES_FOUND=true
    fi
    
    echo "üî¥ Alias '@$alias' usado $COUNT veces:"
    grep "^$alias|" "$TEMP_ALIASES" | sort | uniq | while IFS='|' read -r dup_alias dup_file dup_id; do
      echo "   - $dup_file.md (#$dup_id)"
    done
    echo
  fi
done

if [[ "$DUPLICATES_FOUND" == "false" ]]; then
  echo "‚úÖ Todos los aliases son √∫nicos!"
  echo
  echo "Aliases disponibles:"
  sort "$TEMP_ALIASES" | while IFS='|' read -r alias filename id; do
    [[ -n "$alias" ]] && echo "  @$alias ‚Üí $filename.md (#$id)"
  done
else
  echo "‚ùå Hay aliases duplicados que necesitan ser corregidos."
  echo
  echo "Recomendaci√≥n: Usa aliases m√°s espec√≠ficos como:"
  echo "  @login-prod, @login-staging"
  echo "  @server-web, @server-db"
fi

rm "$TEMP_ALIASES"