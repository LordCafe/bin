#!/bin/bash

# kb - Knowledge Base Terminal - Your Second Brain in the Terminal
# Main command dispatcher

# Load environment variables
if [ -f "$HOME/bin/.env" ]; then 
    set -a
    source "$HOME/bin/.env"
    set +a
fi

COMMANDS_DIR="$HOME/bin/Cheat-sheet"
VERSION="1.0.0"

show_help() {
    cat << 'EOF'
KB Terminal - Your Second Brain in the Terminal

USAGE:
    kb <command> [options]

COMMANDS:
    add <file>              Create new entry (opens editor if no note)
    show <id|file> [count]  Show entry by ID or recent entries from file
    alias <alias>           Find entry by alias (@tag)
    alias <file>:<alias>    Find alias in specific file
    edit <id>               Edit existing entry by ID
    delete <id>             Delete entry by ID
    search [file:]<term>    Search entries globally or in specific file
    check-aliases           Verify alias uniqueness

EXAMPLES:
    kb add docker                    # Create entry with editor
    kb add docker "quick note"       # Create entry with inline note
    kb show 182542                   # Show entry by short ID
    kb show docker 10                # Show last 10 entries from docker.md
    kb alias login-prod              # Find entry with @login-prod alias
    kb alias servers:ssh-key         # Find @ssh-key alias in servers.md
    kb edit 182542                   # Edit entry
    kb search docker                 # Search "docker" globally
    kb search servers:nginx          # Search "nginx" in servers.md only

FEATURES:
    • Lightning-fast alias access (@tags)
    • Unicode diagrams support
    • Git-like UX (colors, pager, navigation)
    • Short IDs (182542 vs 20241205182542)
    • File-specific or global search
    • Zero dependencies (pure bash)

ALIASES:
    Add @aliases to your notes for instant access:
    
    @docker-stack @architecture
    # Docker Development Stack
    ```
    ┌─────────┐    ┌─────────┐    ┌─────────┐
    │  Nginx  │───▶│ PHP-FPM │───▶│  MySQL  │
    └─────────┘    └─────────┘    └─────────┘
    ```

CONFIGURATION:
    Set CHEAT_SHEETS_DIR in ~/.bashrc or ~/bin/.env
    Default: ~/Documents/cheat-sheets

VERSION: 1.0.0
EOF
}

show_version() {
    echo "KB Terminal v$VERSION"
    echo "Your Second Brain in the Terminal"
}

# Handle help and version flags
case "$1" in
    --help|-h|help)
        show_help
        exit 0
        ;;
    --version|-v|version)
        show_version
        exit 0
        ;;
    "")
        echo "KB Terminal - Your Second Brain in the Terminal"
        echo
        echo "Use 'kb --help' for usage information"
        echo "Use 'kb add <file>' to create your first entry"
        exit 1
        ;;
esac

# Get command and shift arguments
COMMAND=$1
shift

# Check if command exists
if [[ ! -f "$COMMANDS_DIR/$COMMAND" ]]; then
    echo "Error: Unknown command '$COMMAND'"
    echo
    echo "Available commands:"
    echo "  add, show, alias, edit, delete, search, check-aliases"
    echo
    echo "Use 'kb --help' for detailed usage"
    exit 1
fi

# Execute the command
exec "$COMMANDS_DIR/$COMMAND" "$@"